<!DOCTYPE html>
<html>
<head>
    <title>The Legend of Suffixia: DX Edition</title>
    <meta charset="utf-8">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #000; 
            font-family: 'Verdana', sans-serif; 
            user-select: none;
        }
        
        /* UI OVERLAY */
        #ui-layer {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #f4f4f4;
            padding: 25px;
            border: 4px solid #2c3e50;
            border-radius: 12px;
            text-align: center;
            display: none; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.7);
            width: 420px;
            z-index: 100;
        }
        
        h2#ui-header { 
            margin: 0 0 15px 0; 
            color: #2c3e50; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }

        p#ui-text { font-size: 18px; color: #555; line-height: 1.6; margin-bottom: 20px; }
        
        input { 
            padding: 12px; font-size: 18px; width: 70%; 
            border: 2px solid #ccc; border-radius: 6px; outline: none; text-align: center;
        }
        input:focus { border-color: #3498db; }

        button { 
            padding: 12px 24px; font-size: 16px; margin-top: 15px; 
            background: #2980b9; color: white; border: none; 
            cursor: pointer; border-radius: 6px; font-weight: bold;
        }
        button:hover { background: #3498db; }
        
        /* HUD */
        .hud { 
            position: absolute; top: 20px; left: 20px; 
            color: white; font-size: 24px; font-weight: bold; 
            text-shadow: 3px 3px 0 #000; pointer-events: none;
            font-family: 'Courier New', monospace;
        }

        #feedback { font-weight: bold; min-height: 24px; margin-top: 15px; }

        /* CLICK TO START OVERLAY */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 30px; font-family: monospace;
            z-index: 200; cursor: pointer;
        }
        
        /* Canvas Styling to ensure it centers */
        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>

    <div id="start-overlay" onclick="startGame()">
        <div>CLICK HERE TO START</div>
    </div>

    <div class="hud">
        <span id="level-display">Level 1</span>
    </div>

    <div id="ui-layer">
        <h2 id="ui-header">Title</h2>
        <p id="ui-text">...</p>
        
        <div id="battle-controls" style="display:none;">
            <input type="text" id="answer-input" placeholder="Type word ending in -ish" autocomplete="off">
            <br>
            <button onclick="checkAnswer()">CAST SPELL</button>
        </div>

        <div id="npc-controls" style="display:none;">
            <button onclick="closeModal()">Close</button>
        </div>

        <p id="feedback"></p>
    </div>

    <script src="https://unpkg.com/kaboom@3000.0.1/dist/kaboom.js"></script>

    <script>
    // 1. INITIALIZE ENGINE
    kaboom({
        background: [15, 15, 20], 
        scale: 3, 
        // FIX 1: Removed the 'canvas' line. 
        // Kaboom will generate its own canvas automatically, preventing the null error.
        crisp: true,
    });

    // 2. ASSETS
    // FIX 2: I commented these out so the game works without local files.
    // If you have the images, uncomment these and remove the color() lines in the level config.
    /*
    loadSprite("hero", "images/hero.png");
    loadSprite("wall", "images/wall.png");
    loadSprite("floor", "images/floor.png");
    loadSprite("enemy", "images/enemy.png");
    loadSprite("boss", "images/boss.png");
    loadSprite("npc", "images/npc.png");        
    loadSprite("stairs", "images/stairs.png"); 
    */

    // --- GAME DATA ---

    const LEVELS = [
        [
            "#####################",
            "#...................#",
            "#.N.......#.........#", 
            "#.........#....1....#", 
            "#...#...............#",
            "#...#........@......#", 
            "#...#...............#",
            "#...#.........>.....#", 
            "#...#...............#",
            "#####################",
        ],
        [
            "#####################",
            "#...>...#...2.......#",
            "#.......#.......#...#",
            "###.#####...#####...#",
            "#.......3.......#...#",
            "#.N.............#...#",
            "#########...#####...#",
            "#...........#.......#",
            "#...@.......#...4...#",
            "#####################",
        ],
        [
            "#####################",
            "#...................#",
            "#...#...#...#...#...#",
            "#...#...#...#...#...#",
            "#...5.......6.......#",
            "#...................#",
            "#.........$.........#", 
            "#...................#",
            "#.........@.........#",
            "#####################",
        ]
    ];

    const QUESTS = {
        "1": { word: "greenish", title: "The Sickly Ghost", clue: "I am not bright green, but I have a sick, pale tint. I am..." },
        "2": { word: "boyish", title: "The Young Knight", clue: "He is a grown man, but he looks very young. He has a ______ face." },
        "3": { word: "ticklish", title: "The Giggle Monster", clue: "If you touch his feet, he laughs! He is very..." },
        "4": { word: "feverish", title: "The Burning Spirit", clue: "My forehead is hot. I feel sick. I am..." },
        "5": { word: "stylish", title: "The Fancy Skeleton", clue: "This skeleton wears the latest fashion trends. He is very..." },
        "6": { word: "devilish", title: "The Prankster", clue: "He plays cruel tricks on people. He has a wicked, ______ sense of humor." },
        "$": { word: "squeamish", title: "THE BOSS", clue: "FINAL TEST: I faint when I see blood. I am easily sickened. I am..." }
    };

    const NPC_DIALOGS = {
        0: "Welcome Hero! To defeat monsters, you must combine the base word with the suffix '-ish'.",
        1: "The forest is dark. Watch your step! Monsters here will test your spelling.",
        2: "This is the final chamber. The boss is very squeamish... oops, I gave you a hint!" 
    };

    // --- SCENES ---

    scene("game", ({ levelIdx }) => {
        
        const levelDisplay = document.getElementById("level-display");
        if(levelDisplay) levelDisplay.innerText = "Level " + (levelIdx + 1);

        // --- GRID CONFIGURATION ---
        const T_SIZE = 16;

        const LEVEL_CONFIG = {
            tileWidth: T_SIZE,
            tileHeight: T_SIZE,
            tiles: {
                // WALL (Gray Block)
                "#": () => [ 
                    rect(T_SIZE, T_SIZE), color(100, 100, 100), outline(1), // Fallback visual
                    area(), 
                    body({ isStatic: true }), 
                    "wall" 
                ], 
                
                // FLOOR (Dark Gray)
                ".": () => [ 
                    rect(T_SIZE, T_SIZE), color(20, 20, 20),
                ],
                
                // STAIRS (Yellow)
                ">": () => [ 
                    rect(T_SIZE, T_SIZE), color(255, 255, 0),
                    area(), 
                    body({ isStatic: true }), 
                    "stairs" 
                ],
                
                // HERO (Blue)
                "@": () => [ 
                    rect(T_SIZE, T_SIZE), color(0, 100, 255),
                    area({ scale: 0.8 }), 
                    body(), 
                    anchor("center"), 
                    "player" 
                ],
                
                // NPC (Green)
                "N": () => [ 
                    rect(T_SIZE, T_SIZE), color(0, 255, 0),
                    area({ scale: 0.8 }), 
                    body({ isStatic: true }), 
                    anchor("center"), 
                    "npc" 
                ],
                
                // ENEMIES (Red)
                "1": () => [ rect(T_SIZE, T_SIZE), color(255, 0, 0), area({ scale: 0.7 }), body({ isStatic: true }), anchor("center"), "enemy", { id: "1" } ],
                "2": () => [ rect(T_SIZE, T_SIZE), color(255, 0, 0), area({ scale: 0.7 }), body({ isStatic: true }), anchor("center"), "enemy", { id: "2" } ],
                "3": () => [ rect(T_SIZE, T_SIZE), color(255, 0, 0), area({ scale: 0.7 }), body({ isStatic: true }), anchor("center"), "enemy", { id: "3" } ],
                "4": () => [ rect(T_SIZE, T_SIZE), color(255, 0, 0), area({ scale: 0.7 }), body({ isStatic: true }), anchor("center"), "enemy", { id: "4" } ],
                "5": () => [ rect(T_SIZE, T_SIZE), color(255, 0, 0), area({ scale: 0.7 }), body({ isStatic: true }), anchor("center"), "enemy", { id: "5" } ],
                "6": () => [ rect(T_SIZE, T_SIZE), color(255, 0, 0), area({ scale: 0.7 }), body({ isStatic: true }), anchor("center"), "enemy", { id: "6" } ],
                
                // BOSS (Purple) 
                "$": () => [ rect(32, 32), color(200, 0, 200), area({ scale: 0.7 }), body({ isStatic: true }), anchor("center"), "boss", { id: "$" } ]
            }
        };

        // Draw the map
        addLevel(LEVELS[levelIdx], LEVEL_CONFIG);

        // Safe player find
        const player = get("player")[0];
        if (!player) return;

        // MOVEMENT
        const SPEED = 140; 
        onKeyDown("left", () => { player.move(-SPEED, 0); }); 
        onKeyDown("right", () => { player.move(SPEED, 0); });
        onKeyDown("up", () => player.move(0, -SPEED));
        onKeyDown("down", () => player.move(0, SPEED));

        // SMOOTH CAMERA
        player.onUpdate(() => {
            camPos(lerp(camPos(), player.pos, dt() * 5));
        });

        // COLLISIONS
        player.onCollide("stairs", () => {
            if (levelIdx < LEVELS.length - 1) {
                go("game", { levelIdx: levelIdx + 1 });
            } else {
                openModal("VICTORY!", "You have conquered all the lands of Suffixia!", false);
            }
        });

        player.onCollide("npc", () => {
            const text = NPC_DIALOGS[levelIdx] || "Hello!";
            openModal("Friendly Wizard", text, false);
        });

        player.onCollide("enemy", (e) => startBattle(e));
        player.onCollide("boss", (b) => startBattle(b));
    });

    // --- UI & BATTLE LOGIC ---

    let currentEnemy = null;

    function startBattle(enemy) {
        currentEnemy = enemy;
        const data = QUESTS[enemy.id];
        openModal(data.title, data.clue, true); 
    }

    function openModal(header, text, isBattle) {
        debug.paused = true; 
        
        const ui = document.getElementById("ui-layer");
        const battleControls = document.getElementById("battle-controls");
        const npcControls = document.getElementById("npc-controls");
        const feedback = document.getElementById("feedback");
        
        document.getElementById("ui-header").innerText = header;
        document.getElementById("ui-text").innerText = text;
        feedback.innerText = "";
        feedback.style.color = "black";

        ui.style.display = "block";

        if (isBattle) {
            battleControls.style.display = "block";
            npcControls.style.display = "none";
            const input = document.getElementById("answer-input");
            input.value = "";
            setTimeout(() => input.focus(), 100); 
        } else {
            battleControls.style.display = "none";
            npcControls.style.display = "block";
        }
    }

    window.closeModal = function() {
        document.getElementById("ui-layer").style.display = "none";
        debug.paused = false;
        // Focus back on canvas so keys work immediately
        document.querySelector("canvas").focus();
    }

    window.checkAnswer = function() {
        const input = document.getElementById("answer-input");
        const feedback = document.getElementById("feedback");
        
        if (!currentEnemy) return;
        const data = QUESTS[currentEnemy.id];

        if (input.value.toLowerCase().trim() === data.word) {
            const pos = currentEnemy.pos; 
            currentEnemy.destroy(); 
            closeModal();
            shake(4); 
            addKaboom(pos); 
        } else {
            feedback.innerText = "WRONG! Try again.";
            feedback.style.color = "red";
            shake(10); 
            input.value = "";
            input.focus();
        }
    }
    
    document.getElementById("answer-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") { window.checkAnswer(); }
    });

    window.startGame = function() {
        document.getElementById("start-overlay").style.display = "none";
        go("game", { levelIdx: 0 });
    }

    </script>
</body>
</html>
