<!DOCTYPE html>
<html>
<head>
    <title>Suffixia: Geometric Edition</title>
    <meta charset="utf-8">
    <style>
        body { margin: 0; background-color: #111; font-family: monospace; color: white; overflow: hidden; }

        /* CRASH REPORTER */
        #error-console {
            display: none; position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(200, 0, 0, 0.9); color: white; padding: 20px; 
            z-index: 9999; font-size: 18px; white-space: pre-wrap; border-bottom: 4px solid white;
        }

        /* START OVERLAY */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 200; cursor: pointer;
        }

        /* GAME UI */
        #ui-layer {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; color: #000; padding: 20px; border: 4px solid #444;
            text-align: center; display: none; width: 300px; z-index: 100;
        }

        input { padding: 10px; font-size: 16px; width: 80%; text-align: center; margin: 10px 0; }
        button { padding: 10px 20px; cursor: pointer; background: #333; color: white; border: none; font-weight: bold; font-size: 16px; }
        button:hover { background: #555; }
        canvas { outline: none; }
    </style>
</head>
<body>

    <div id="error-console"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const box = document.getElementById("error-console");
            box.style.display = "block";
            box.innerText = "⚠️ ERROR: " + message + "\nLine: " + lineno;
        };
    </script>

    <div id="start-overlay">
        <h1 style="font-size: 40px; margin-bottom: 10px;">CLICK TO START</h1>
        <p style="color: #aaa;">(Pure Code Mode - No Images)</p>
    </div>

    <div id="ui-layer">
        <h2 id="ui-header">...</h2>
        <p id="ui-text">...</p>
        <div id="battle-controls" style="display:none;">
            <input type="text" id="answer-input" placeholder="Type -ish word" autocomplete="off">
            <br><button id="submit-btn">CAST SPELL</button>
        </div>
        <div id="npc-controls" style="display:none;">
            <button id="close-btn">LEAVE</button>
        </div>
    </div>

    <script src="https://unpkg.com/kaboom@3000.0.1/dist/kaboom.js"></script>

    <script>
    try {
        kaboom({
            background: [20, 20, 30], 
            scale: 2, 
            canvas: document.querySelector("canvas"),
        });

        scene("game", ({ levelIdx }) => {
            
            add([ text("Level " + (levelIdx + 1), { size: 16 }), pos(10, 10), fixed() ]);
            
            const LEVELS = [
                [
                    "#####################",
                    "#...................#",
                    "#.N.......#.........#", 
                    "#.........#....1....#", 
                    "#...#...............#",
                    "#...#........@......#", 
                    "#...#...............#",
                    "#...#.........>.....#", 
                    "#...#...............#",
                    "#####################",
                ]
            ];

            // THE FIX: We use rect() and color() instead of sprite()
            // This bypasses the image loading system entirely.
            addLevel(LEVELS[0], {
                tileWidth: 16,
                tileHeight: 16,
                tiles: {
                    // WALL (Gray Block)
                    "#": () => [ 
                        rect(16, 16), color(100, 100, 100), 
                        area(), body({isStatic:true}), "wall" 
                    ],
                    // FLOOR (Dark Block - Visual Only)
                    ".": () => [ 
                        rect(16, 16), color(30, 30, 40) 
                    ],
                    // STAIRS (Yellow Block)
                    ">": () => [ 
                        rect(16, 16), color(255, 255, 0), 
                        area(), body({isStatic:true}), "stairs" 
                    ],
                    // HERO (Blue Block)
                    "@": () => [ 
                        rect(16, 16), color(0, 0, 255), 
                        area({scale:0.8}), body(), anchor("center"), "player" 
                    ],
                    // NPC (Green Block)
                    "N": () => [ 
                        rect(16, 16), color(0, 255, 0), 
                        area(), body({isStatic:true}), anchor("center"), "npc" 
                    ],
                    // ENEMY (Red Block)
                    "1": () => [ 
                        rect(16, 16), color(255, 0, 0), 
                        area(), body({isStatic:true}), anchor("center"), "enemy", {id:"1"} 
                    ],
                }
            });

            const SPEED = 140;
            
            // Movement Logic
            function move(x, y) {
                const p = get("player")[0];
                if(p) p.move(x, y);
            }

            onKeyDown("left", () => move(-SPEED, 0));
            onKeyDown("right", () => move(SPEED, 0));
            onKeyDown("up", () => move(0, -SPEED));
            onKeyDown("down", () => move(0, SPEED));

            // Camera
            onUpdate(() => {
                const p = get("player")[0];
                if(p) camPos(lerp(camPos(), p.pos, dt()*5));
            });

            // Interactions
            onCollide("player", "stairs", () => debug.log("Win!"));
            onCollide("player", "npc", () => openModal("Wizard", "Combine words with -ish!", false));
            onCollide("player", "enemy", (p, e) => startBattle(e));
        });

        // UI Logic
        let currentEnemy = null;
        const QUESTS = { "1": { word: "greenish", title: "Ghost", clue: "Sickly color..." } };

        function startBattle(enemy) {
            currentEnemy = enemy;
            const data = QUESTS[enemy.id];
            if(data) openModal(data.title, data.clue, true);
        }

        function openModal(header, text, isBattle) {
            debug.paused = true;
            document.getElementById("ui-layer").style.display = "block";
            document.getElementById("ui-header").innerText = header;
            document.getElementById("ui-text").innerText = text;
            document.getElementById("battle-controls").style.display = isBattle ? "block" : "none";
            document.getElementById("npc-controls").style.display = isBattle ? "none" : "block";
            if(isBattle) setTimeout(() => document.getElementById("answer-input").focus(), 100);
        }

        function closeModal() {
            document.getElementById("ui-layer").style.display = "none";
            debug.paused = false;
            document.querySelector("canvas").focus();
        }

        function checkAnswer() {
            const input = document.getElementById("answer-input");
            if (input.value.includes("ish")) {
                if(currentEnemy) currentEnemy.destroy();
                closeModal();
                shake(5);
            } else {
                alert("Try typing 'greenish'");
            }
        }

        // Start
        document.getElementById("start-overlay").addEventListener("click", () => {
            document.getElementById("start-overlay").style.display = "none";
            go("game", { levelIdx: 0 });
            setTimeout(() => document.querySelector("canvas").focus(), 100);
        });

        document.getElementById("submit-btn").addEventListener("click", checkAnswer);
        document.getElementById("close-btn").addEventListener("click", closeModal);

    } catch (e) {
        alert("Startup Error: " + e.message);
    }
    </script>
</body>
</html>
