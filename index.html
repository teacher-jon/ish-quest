<!DOCTYPE html>
<html>
<head>
    <title>The Legend of Suffixia: DX Edition</title>
    <meta charset="utf-8">
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; font-family: 'Verdana', sans-serif; }
        
        /* UI OVERLAY (Shared for Battles and NPCs) */
        #ui-layer {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border: 4px solid #4a90e2;
            border-radius: 10px;
            text-align: center;
            display: none; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 400px;
            z-index: 100;
        }
        h2 { margin: 0 0 10px 0; color: #333; }
        p#ui-text { font-size: 18px; color: #555; line-height: 1.5; }
        
        /* Battle Specific Inputs */
        #battle-controls { display: none; }
        input { padding: 10px; font-size: 16px; width: 80%; margin-top: 10px; }
        button { padding: 10px 20px; font-size: 16px; margin-top: 10px; background: #4a90e2; color: white; border: none; cursor: pointer; border-radius: 5px; }
        button:hover { background: #357abd; }
        
        .hud { position: absolute; top: 10px; left: 10px; color: white; font-size: 20px; font-weight: bold; text-shadow: 2px 2px #000; pointer-events: none;}
    </style>
</head>
<body>

    <div class="hud">
        <span id="level-display">Level 1</span>
    </div>

    <div id="ui-layer">
        <h2 id="ui-header">Title</h2>
        <p id="ui-text">...</p>
        
        <div id="battle-controls">
            <input type="text" id="answer-input" placeholder="Type -ish word..." autocomplete="off">
            <br>
            <button onclick="checkAnswer()">Attack!</button>
        </div>

        <div id="npc-controls">
            <button onclick="closeModal()">Goodbye</button>
        </div>

        <p id="feedback" style="font-weight: bold; color: red; min-height: 20px; margin-top:5px;"></p>
    </div>

    <script src="https://unpkg.com/kaboom@3000.0.1/dist/kaboom.js"></script>

    <script>
    // 1. START GAME
    kaboom({
        background: [20, 20, 30], 
        scale: 2, 
    });

    // --- CONFIGURATION ---
    // If your images are still huge, change this number to 0.05 or 0.1
    // If your images are already small (32x32), keep this at 1
    const SPRITE_SCALE = 1; 

    // 2. LOAD ASSETS
    loadSprite("hero", "hero.png");
    loadSprite("wall", "wall.png");
    loadSprite("floor", "floor.png");
    loadSprite("enemy", "enemy.png");
    loadSprite("boss", "boss.png");
    loadSprite("npc", "npc.png");       
    loadSprite("stairs", "stairs.png"); 

    // 3. DEFINE LEVELS
    const levels = [
        // LEVEL 1: The Village (Tutorial)
        [
            "#####################",
            "#...................#",
            "#.N.......#.........#", 
            "#.........#....1....#", 
            "#...#...............#",
            "#...#........@......#", 
            "#...#...............#",
            "#...#.........>.....#", 
            "#...#...............#",
            "#####################",
        ],
        // LEVEL 2: The Dark Forest
        [
            "#####################",
            "#...>...#...2.......#",
            "#.......#.......#...#",
            "###.#####...#####...#",
            "#.......3.......#...#",
            "#.N.............#...#",
            "#########...#####...#",
            "#...........#.......#",
            "#...@.......#...4...#",
            "#####################",
        ],
        // LEVEL 3: The Boss Dungeon
        [
            "#####################",
            "#...................#",
            "#...#...#...#...#...#",
            "#...#...#...#...#...#",
            "#...5.......6.......#",
            "#...................#",
            "#.........$.........#", 
            "#...................#",
            "#.........@.........#",
            "#####################",
        ]
    ];

    // 4. QUEST DATA
    const quests = {
        "1": { word: "greenish", title: "The Sickly Ghost", clue: "I am not bright green, but I have a sick, pale tint. I am..." },
        "2": { word: "boyish", title: "The Young Knight", clue: "He is a grown man, but he looks very young. He has a ______ face." },
        "3": { word: "ticklish", title: "The Giggle Monster", clue: "If you touch his feet, he laughs! He is very..." },
        "4": { word: "feverish", title: "The Burning Spirit", clue: "My forehead is hot. I feel sick. I am..." },
        "5": { word: "stylish", title: "The Fancy Skeleton", clue: "This skeleton wears the latest fashion trends. He is very..." },
        "6": { word: "devilish", title: "The Prankster", clue: "He plays cruel tricks on people. He has a wicked, ______ sense of humor." },
        "$": { word: "squeamish", title: "THE BOSS", clue: "FINAL TEST: I faint when I see blood. I am easily sickened. I am..." }
    };

    // 5. NPC DIALOG DATA
    const npcDialogs = {
        0: "Welcome Hero! To defeat monsters here, you must add '-ish' to words. If something is 'somewhat green', it is Greenish!",
        1: "Be careful in the forest! The monsters there are tricky. Remember, '-ish' can also mean 'having the qualities of' something.",
        2: "There is no one here... but you feel a chill." 
    };

    // --- GAME LOGIC ---

    scene("game", ({ levelIdx }) => {
        
        // Update HUD
        const levelDisplay = document.getElementById("level-display");
        levelDisplay.innerText = "Level " + (levelIdx + 1);

        const LEVEL_CONFIG = {
            tileWidth: 16,
            tileHeight: 16,
            tiles: {
                // We apply SPRITE_SCALE here to fix image size issues automatically
                "#": () => [ sprite("wall"), scale(SPRITE_SCALE), area(), body({ isStatic: true }), "wall" ], 
                ".": () => [ sprite("floor"), scale(SPRITE_SCALE) ],
                ">": () => [ sprite("stairs"), scale(SPRITE_SCALE), area(), body({ isStatic: true }), "stairs" ],
                "@": () => [ sprite("hero"), scale(SPRITE_SCALE), area(), body(), anchor("center"), "player" ],
                "N": () => [ sprite("npc"), scale(SPRITE_SCALE), area(), body({ isStatic: true }), anchor("center"), "npc" ],
                
                // Enemies
                "1": () => [ sprite("enemy"), scale(SPRITE_SCALE), area(), body({ isStatic: true }), anchor("center"), "enemy", { id: "1" } ],
                "2": () => [ sprite("enemy"), scale(SPRITE_SCALE), area(), body({ isStatic: true }), anchor("center"), "enemy", { id: "2" } ],
                "3": () => [ sprite("enemy"), scale(SPRITE_SCALE), area(), body({ isStatic: true }), anchor("center"), "enemy", { id: "3" } ],
                "4": () => [ sprite("enemy"), scale(SPRITE_SCALE), area(), body({ isStatic: true }), anchor("center"), "enemy", { id: "4" } ],
                "5": () => [ sprite("enemy"), scale(SPRITE_SCALE), area(), body({ isStatic: true }), anchor("center"), "enemy", { id: "5" } ],
                "6": () => [ sprite("enemy"), scale(SPRITE_SCALE), area(), body({ isStatic: true }), anchor("center"), "enemy", { id: "6" } ],
                "$": () => [ sprite("boss"), scale(SPRITE_SCALE), area(), body({ isStatic: true }), anchor("center"), "boss", { id: "$" } ]
            }
        };

        // Draw the map
        addLevel(levels[levelIdx], LEVEL_CONFIG);

        // --- FIX FOR TYPE ERROR ---
        // Instead of trying to create the player again, we find the one 
        // that the map just created using the '@' symbol.
        const player = get("player")[0];

        // MOVEMENT
        const SPEED = 120;
        onKeyDown("left", () => { player.move(-SPEED, 0); player.flipX = true; }); 
        onKeyDown("right", () => { player.move(SPEED, 0); player.flipX = false; });
        onKeyDown("up", () => player.move(0, -SPEED));
        onKeyDown("down", () => player.move(0, SPEED));

        player.onUpdate(() => { camPos(player.pos); });

        // --- COLLISIONS ---

        // 1. STAIRS (Next Level)
        player.onCollide("stairs", () => {
            if (levelIdx < levels.length - 1) {
                go("game", { levelIdx: levelIdx + 1 });
            } else {
                openModal("Victory!", "You have conquered all the lands of Suffixia!", false);
            }
        });

        // 2. NPCs (Talk)
        player.onCollide("npc", () => {
            const text = npcDialogs[levelIdx];
            openModal("Friendly Wizard", text, false);
        });

        // 3. ENEMIES (Battle)
        player.onCollide("enemy", (e) => startBattle(e));
        player.onCollide("boss", (b) => startBattle(b));

    });

    // --- UI SYSTEM ---

    let currentEnemy = null;

    function startBattle(enemy) {
        currentEnemy = enemy;
        const data = quests[enemy.id];
        openModal(data.title, data.clue, true); 
    }

    function openModal(header, text, isBattle) {
        debug.paused = true;
        
        const ui = document.getElementById("ui-layer");
        const battleControls = document.getElementById("battle-controls");
        const npcControls = document.getElementById("npc-controls");
        
        document.getElementById("ui-header").innerText = header;
        document.getElementById("ui-text").innerText = text;
        document.getElementById("feedback").innerText = "";

        ui.style.display = "block";

        if (isBattle) {
            battleControls.style.display = "block";
            npcControls.style.display = "none";
            const input = document.getElementById("answer-input");
            input.value = "";
            input.focus();
        } else {
            battleControls.style.display = "none";
            npcControls.style.display = "block";
        }
    }

    window.closeModal = function() {
        document.getElementById("ui-layer").style.display = "none";
        debug.paused = false;
    }

    window.checkAnswer = function() {
        const input = document.getElementById("answer-input");
        const feedback = document.getElementById("feedback");
        const data = quests[currentEnemy.id];

        if (input.value.toLowerCase().trim() === data.word) {
            currentEnemy.destroy(); 
            closeModal();
            shake(2); 
        } else {
            feedback.innerText = "WRONG! Try again.";
            shake(2);
            input.value = "";
            input.focus();
        }
    }
    
    // Enter key support
    document.getElementById("answer-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") { window.checkAnswer(); }
    });

    // START THE GAME AT LEVEL 0
    go("game", { levelIdx: 0 });

    </script>
</body>
</html>
