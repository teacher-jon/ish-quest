<!DOCTYPE html>
<html>
<head>
    <title>Suffixia: Final Fix</title>
    <meta charset="utf-8">
    <style>
        body { margin: 0; overflow: hidden; background-color: #222; font-family: monospace; user-select: none; }

        /* START OVERLAY */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            color: white; z-index: 200; cursor: pointer;
        }
        
        /* UI OVERLAY */
        #ui-layer {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; padding: 20px; border: 4px solid #000;
            text-align: center; display: none; width: 300px; z-index: 100;
        }
        
        input { padding: 10px; font-size: 16px; width: 80%; text-align: center; margin: 10px 0; }
        button { padding: 8px 16px; cursor: pointer; background: #333; color: white; border: none; font-weight: bold;}
        button:hover { background: #555; }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h1 style="font-size: 40px; margin-bottom: 10px;">CLICK TO START</h1>
        <p>(Controls: Arrow Keys)</p>
    </div>

    <div id="ui-layer">
        <h2 id="ui-header">...</h2>
        <p id="ui-text">...</p>
        <div id="battle-controls" style="display:none;">
            <input type="text" id="answer-input" placeholder="Type -ish word" autocomplete="off">
            <br><button id="submit-btn">CAST SPELL</button>
        </div>
        <div id="npc-controls" style="display:none;">
            <button id="close-btn">LEAVE</button>
        </div>
        <p id="feedback" style="color:red; font-weight:bold; height:20px;"></p>
    </div>

    <script src="https://unpkg.com/kaboom@3000.0.1/dist/kaboom.js"></script>

    <script>
    // 1. INITIALIZE ENGINE
    kaboom({
        background: [20, 20, 30], 
        scale: 2, 
        canvas: document.querySelector("canvas"),
        debug: true, // Shows FPS
    });

    // 2. CREATE ASSETS (Internal Code - No Images Required)
    // This prevents the "Black Box" issue completely.
    
    loadSprite("hero", {
        width: 16, height: 16,
        draw() {
            drawRect({ width: 16, height: 16, color: rgb(50, 100, 255) }); // BLUE PLAYER
            drawRect({ width: 4, height: 4, pos: vec2(4, 4), color: rgb(255, 255, 255) }); // Eye
            drawRect({ width: 4, height: 4, pos: vec2(10, 4), color: rgb(255, 255, 255) }); // Eye
        }
    });

    loadSprite("wall", {
        width: 16, height: 16,
        draw() {
            drawRect({ width: 16, height: 16, color: rgb(100, 100, 100) }); // GRAY WALL
            drawRect({ width: 14, height: 14, pos: vec2(1,1), color: rgb(80, 80, 80) }); 
        }
    });

    loadSprite("floor", {
        width: 16, height: 16,
        draw() { drawRect({ width: 16, height: 16, color: rgb(30, 30, 40) }); }
    });

    loadSprite("enemy", {
        width: 16, height: 16,
        draw() { drawRect({ width: 16, height: 16, color: rgb(255, 50, 50) }); } // RED ENEMY
    });

    loadSprite("npc", {
        width: 16, height: 16,
        draw() { drawRect({ width: 16, height: 16, color: rgb(50, 200, 50) }); } // GREEN NPC
    });
    
    loadSprite("stairs", {
        width: 16, height: 16,
        draw() { drawRect({ width: 16, height: 16, color: rgb(255, 255, 0) }); } // YELLOW STAIRS
    });

    loadSprite("boss", {
        width: 32, height: 32,
        draw() { drawRect({ width: 32, height: 32, color: rgb(150, 0, 150) }); } // PURPLE BOSS
    });

    // --- GAME LOGIC ---

    scene("game", ({ levelIdx }) => {
        
        // Setup UI
        const T_SIZE = 16;
        add([ text("Level " + (levelIdx + 1), { size: 16 }), pos(10, 10), fixed() ]);
        
        // Debug Input Text (To see if keys work)
        const debugText = add([ text("Input: None", { size: 12 }), pos(10, 30), fixed(), color(0, 255, 0) ]);

        const LEVELS = [
            [
                "#####################",
                "#...................#",
                "#.N.......#.........#", 
                "#.........#....1....#", 
                "#...#...............#",
                "#...#........@......#", 
                "#...#...............#",
                "#...#.........>.....#", 
                "#...#...............#",
                "#####################",
            ],
            [
                "#####################",
                "#...>...#...2.......#",
                "#.......#.......#...#",
                "###.#####...#####...#",
                "#.......3.......#...#",
                "#.N.............#...#",
                "#########...#####...#",
                "#...........#.......#",
                "#...@.......#...4...#",
                "#####################",
            ]
        ];

        addLevel(LEVELS[levelIdx] || LEVELS[0], {
            tileWidth: T_SIZE,
            tileHeight: T_SIZE,
            tiles: {
                "#": () => [ sprite("wall"), area(), body({isStatic:true}), "wall" ],
                ".": () => [ sprite("floor") ],
                ">": () => [ sprite("stairs"), area(), body({isStatic:true}), "stairs" ],
                "@": () => [ sprite("hero"), area({scale: 0.8}), body(), anchor("center"), "player" ], // 0.8 scale prevents sticking
                "N": () => [ sprite("npc"), area(), body({isStatic:true}), anchor("center"), "npc" ],
                "1": () => [ sprite("enemy"), area(), body({isStatic:true}), anchor("center"), "enemy", {id:"1"} ],
                "2": () => [ sprite("enemy"), area(), body({isStatic:true}), anchor("center"), "enemy", {id:"2"} ],
                "3": () => [ sprite("enemy"), area(), body({isStatic:true}), anchor("center"), "enemy", {id:"3"} ],
                "4": () => [ sprite("enemy"), area(), body({isStatic:true}), anchor("center"), "enemy", {id:"4"} ],
                "$": () => [ sprite("boss"), area(), body({isStatic:true}), anchor("center"), "boss", {id:"$"} ],
            }
        });

        // SAFE MOVEMENT CONTROLS
        // We find the player inside the key handler to ensure we don't crash if loading takes time.
        const SPEED = 140;

        function movePlayer(x, y, label) {
            const p = get("player")[0];
            if (p) {
                p.move(x, y);
                debugText.text = "Input: " + label;
            }
        }

        onKeyDown("left", () => movePlayer(-SPEED, 0, "Left"));
        onKeyDown("right", () => movePlayer(SPEED, 0, "Right"));
        onKeyDown("up", () => movePlayer(0, -SPEED, "Up"));
        onKeyDown("down", () => movePlayer(0, SPEED, "Down"));
        
        // Camera Follow
        const p = get("player")[0];
        if(p) camPos(p.pos);
        onUpdate(() => {
            const p = get("player")[0];
            if(p) camPos(lerp(camPos(), p.pos, dt()*5));
        });

        // COLLISIONS
        onCollide("player", "stairs", () => go("game", { levelIdx: levelIdx + 1 }));
        onCollide("player", "npc", () => openModal("Wizard", "Combine words with -ish!", false));
        onCollide("player", "enemy", (p, e) => startBattle(e));
    });

    // --- UI LOGIC ---
    let currentEnemy = null;
    const QUESTS = {
        "1": { word: "greenish", title: "Ghost", clue: "Sick, pale tint..." },
        "2": { word: "boyish", title: "Knight", clue: "Grown man, young face..." },
        "3": { word: "ticklish", title: "Monster", clue: "Laughs when feet touched..." },
        "4": { word: "feverish", title: "Spirit", clue: "Hot forehead..." },
    };

    function startBattle(enemy) {
        currentEnemy = enemy;
        const data = QUESTS[enemy.id];
        if(data) openModal(data.title, data.clue, true);
    }

    function openModal(header, text, isBattle) {
        debug.paused = true;
        document.getElementById("ui-layer").style.display = "block";
        document.getElementById("ui-header").innerText = header;
        document.getElementById("ui-text").innerText = text;
        document.getElementById("battle-controls").style.display = isBattle ? "block" : "none";
        document.getElementById("npc-controls").style.display = isBattle ? "none" : "block";
        
        if(isBattle) setTimeout(() => document.getElementById("answer-input").focus(), 100);
    }

    function closeModal() {
        document.getElementById("ui-layer").style.display = "none";
        debug.paused = false;
        // Re-focus canvas so player can move again
        document.querySelector("canvas").focus();
    }

    function checkAnswer() {
        const input = document.getElementById("answer-input");
        if (!currentEnemy) return;
        const data = QUESTS[currentEnemy.id];
        
        if (input.value.toLowerCase().trim() === data.word) {
            currentEnemy.destroy();
            closeModal();
            shake(5);
        } else {
            document.getElementById("feedback").innerText = "WRONG!";
        }
    }

    // --- STARTUP LOGIC ---
    document.getElementById("start-overlay").addEventListener("click", () => {
        document.getElementById("start-overlay").style.display = "none";
        
        // 1. Start Audio Context
        burp(); 
        
        // 2. Start Game Loop
        go("game", { levelIdx: 0 });

        // 3. FORCE FOCUS (Crucial for controls)
        setTimeout(() => {
            const canvas = document.querySelector("canvas");
            if (canvas) canvas.focus();
        }, 100);
    });

    document.getElementById("submit-btn").addEventListener("click", checkAnswer);
    document.getElementById("close-btn").addEventListener("click", closeModal);
    document.getElementById("answer-input").addEventListener("keypress", (e) => {
        if (e.key === "Enter") checkAnswer();
    });

    </script>
</body>
</html>
