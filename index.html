<!DOCTYPE html>
<html>
<head>
    <title>Suffixia: Fixed Level 2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; 
            background: #050505; 
            overflow: hidden; 
            font-family: 'Verdana', sans-serif; 
            color: white; 
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; 
        }
        
        canvas { 
            display: block; 
            background: #000; 
            margin: 0 auto;
        }
        
        /* HUD */
        #hud {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 12px;
            border: 2px solid #555; pointer-events: none;
            display: flex; gap: 15px; font-size: 16px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 10;
            flex-wrap: wrap;
        }
        .hud-item { display: flex; align-items: center; gap: 5px; }
        .hud-value { color: #a29bfe; }
        #rank-display { color: #ffeaa7; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }

        /* START SCREEN */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 15, 0.98); z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #start-btn {
            padding: 20px 50px; font-size: 24px; font-weight: bold; 
            background: #6c5ce7; color: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 30px rgba(108, 92, 231, 0.6);
            margin-bottom: 20px; transition: transform 0.2s;
        }
        #start-btn:hover { transform: scale(1.05); background: #81ecec; color: #2d3436; }

        /* UI POPUP */
        #ui-layer {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(25, 25, 35, 0.98); 
            color: #eee; 
            padding: 30px; 
            border: 4px solid #6c5ce7;
            border-radius: 20px;
            text-align: center; 
            display: none; 
            width: 80%; max-width: 500px;
            box-shadow: 0 0 100px rgba(108, 92, 231, 0.6);
            z-index: 100;
        }

        h2#ui-title { margin-top: 0; color: #a29bfe; text-transform: uppercase; letter-spacing: 3px; border-bottom: 2px solid #444; padding-bottom: 15px; font-size: 24px;}
        p#ui-text { font-size: 18px; line-height: 1.6; margin: 20px 0; min-height: 50px; }

        input { 
            padding: 15px; font-size: 22px; text-align: center; width: 80%; margin-top: 15px;
            background: #2d3436; border: 2px solid #636e72; color: white; border-radius: 10px; outline: none;
        }
        input:focus { border-color: #a29bfe; box-shadow: 0 0 10px #a29bfe; }
        
        button.action-btn { 
            padding: 15px 30px; font-size: 18px; cursor: pointer; margin-top: 25px;
            background: #6c5ce7; color: white; border: none; border-radius: 8px; font-weight: bold;
            transition: all 0.2s; width: 100%;
        }
        button.action-btn:hover { background: #81ecec; color: black; }

        /* MOBILE CONTROLS */
        #mobile-controls {
            position: absolute; bottom: 20px; left: 20px;
            display: grid; 
            grid-template-columns: 60px 60px 60px;
            grid-template-rows: 60px 60px;
            gap: 10px;
            z-index: 50;
        }
        
        .dpad-btn {
            width: 60px; height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            color: white; font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; user-select: none;
            transition: background 0.1s;
        }
        .dpad-btn:active { background: rgba(108, 92, 231, 0.8); border-color: #a29bfe; }
        
        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-down { grid-column: 2; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }

    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 50px; color: #a29bfe; margin-bottom: 10px; text-shadow: 0 0 30px #6c5ce7;">SUFFIXIA</h1>
        <p style="color:#aaa; margin-bottom: 40px; font-size: 16px;">The Legend of the Word Warden</p>
        <button id="start-btn" onclick="initGame()">PLAY</button>
    </div>
    
    <div id="hud">
        <div class="hud-item">üèÜ <span id="score-val" class="hud-value">0</span></div>
        <div class="hud-item">üîë <span id="key-count" class="hud-value">0</span></div>
        <div class="hud-item">üß™ <span id="potion-status" class="hud-value">OFF</span></div>
        <div class="hud-item" style="border-left: 1px solid #555; padding-left: 10px;">
            <span id="rank-display">NOVICE</span>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="mobile-controls">
        <div class="dpad-btn" id="btn-up" onpointerdown="handleInput(0, -1)">‚ñ≤</div>
        <div class="dpad-btn" id="btn-left" onpointerdown="handleInput(-1, 0)">‚óÄ</div>
        <div class="dpad-btn" id="btn-down" onpointerdown="handleInput(0, 1)">‚ñº</div>
        <div class="dpad-btn" id="btn-right" onpointerdown="handleInput(1, 0)">‚ñ∂</div>
    </div>

    <div id="ui-layer">
        <h2 id="ui-title">Quest</h2>
        <p id="ui-text">...</p>
        
        <div id="battle-ui" style="display:none">
            <input type="text" id="answer" placeholder="Type answer..." autocomplete="off">
            <br>
            <button class="action-btn" onclick="checkAnswer()">CAST SPELL</button>
        </div>
        
        <button id="close-btn" class="action-btn" onclick="closeUI()" style="display:none">CONTINUE</button>
        <p id="feedback" style="color:#ff7675; font-weight:bold; min-height: 20px; margin-top:15px;"></p>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const TILE_SIZE = 64; 
        const CANVAS = document.getElementById("gameCanvas");
        const CTX = CANVAS.getContext("2d");

        // --- 2. AUDIO ENGINE (Safe Mode) ---
        const Audio = {
            ctx: null,
            active: false,
            init: function() {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                    this.active = true;
                    this.startBGM();
                } catch (e) { this.active = false; }
            },
            playTone: function(freq, type, duration) {
                if (!this.active || !this.ctx) return;
                try {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(0.05, this.ctx.currentTime); 
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + duration);
                } catch(e) {}
            },
            pickup: () => { Audio.playTone(600, 'sine', 0.1); setTimeout(() => Audio.playTone(1200, 'sine', 0.2), 100); },
            unlock: () => { Audio.playTone(200, 'sawtooth', 0.2); setTimeout(() => Audio.playTone(400, 'sawtooth', 0.3), 200); },
            magic: () => Audio.playTone(600, 'sine', 0.3),
            error: () => Audio.playTone(100, 'sawtooth', 0.3),
            step: () => Audio.playTone(100, 'triangle', 0.05),
            levelup: () => { [440, 554, 659, 880].forEach((n, i) => setTimeout(() => Audio.playTone(n, 'square', 0.4), i * 100)); },
            startBGM: function() {
                if (!this.active || !this.ctx) return;
                try {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.frequency.value = 55; 
                    osc.type = 'triangle';
                    gain.gain.value = 0.05; 
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                } catch(e) {}
            }
        };

        // --- 3. ASSETS ---
        const ASSETS = { "@": "images/hero.png", "#": "images/wall.png", ".": "images/floor.png", "N": "images/npc.png", ">": "images/stairs.png", "E": "images/enemy.png", "$": "images/boss.png" };
        const IMAGES = {};
        let assetsLoaded = 0;
        const totalAssets = Object.keys(ASSETS).length;

        function preloadImages() {
            for (let key in ASSETS) {
                const img = new Image();
                img.src = ASSETS[key];
                img.onload = () => { assetsLoaded++; };
                img.onerror = () => { assetsLoaded++; }; 
                IMAGES[key] = img;
            }
        }
        
        // --- 4. DATA ---
        const REGULAR_QUESTIONS = [
            { a: "greenish", q: "Somewhat green." }, { a: "boyish", q: "Like a boy." },
            { a: "girlish", q: "Like a girl." }, { a: "childish", q: "Immature; like a child." },
            { a: "ticklish", q: "Sensitive to tickling." }, { a: "feverish", q: "Having a fever." },
            { a: "stylish", q: "Fashionable." }, { a: "foolish", q: "Lacking sense." },
            { a: "selfish", q: "Caring only for self." }, { a: "pinkish", q: "Slightly pink." }
        ];

        const BOSS_QUESTIONS = [
            { a: "adjective", q: "Does the suffix '-ish' turn a noun into a Verb or Adjective?" },
            { a: "quality of", q: "Does '-ish' mean 'without' or 'having the quality of'?" },
            { a: "noun", q: "To make 'Foolish', do you add -ish to a Noun or Verb?" }
        ];

        const STORY_TEXT = [
            "Welcome, Word Warden. The Suffix Sorcerer has stolen the endings of our words! You must reclaim them!",
            "You have entered the Chasm. The rooms are split by a great wall. You must find the key to open the central door!",
            "The Throne Room. The Sorcerer waits behind the final door."
        ];

        const RANKS = [
            { score: 0, title: "NOVICE" },
            { score: 200, title: "APPRENTICE" },
            { score: 500, title: "SPELLBINDER" },
            { score: 800, title: "WORD MASTER" },
            { score: 1200, title: "LEGEND" }
        ];

        // --- 5. GAME STATE ---
        let player = { x: 1, y: 1 };
        let inventory = { keys: 0, vision: false, score: 0 };
        let levelIdx = 0;
        let isPaused = false;
        let currentEnemy = null;
        let walls = [];
        let items = [];
        let moveTimer = 0;

        // --- 6. LEVELS (FIXED LEVEL 2) ---
        const LEVELS = [
            // LEVEL 1: TUTORIAL
            [ 
                "####################", 
                "#@.......E....K....#", 
                "#.N...H............#", 
                "#######D############", 
                "#...........E......#", 
                "#...P.......#......#", 
                "#...#.......E......#", 
                "#...#...E....>.....#", 
                "#...#..............#", 
                "####################" 
            ],
            
            // LEVEL 2: THE BRIDGE (Redesigned for guaranteed solvability)
            // Left Side: Start @, Key K, Potion P
            // Middle: Wall # with Door D
            // Right Side: Exit >
            [
                "#######################",
                "#@........#...........#", 
                "#.........#...........#",
                "#...E.....#.....E.....#",
                "#.........D...........#", // Door connects the two rooms
                "#...K.....#...........#", // Key is clearly in the starting room
                "#.........#......>....#", 
                "#.........#...........#",
                "#######################"
            ],
            
            // LEVEL 3: THE ARENA
            [ 
                "#######################", 
                "#@....................#", 
                "#######.#######.#######", 
                "#.....#.#.....#.#.....#", 
                "#..E..#.#..$..#.#..K..#", 
                "#.....#.#.....#.#.....#", 
                "#.#####.###D###.#######", 
                "#.........H...........#", 
                "#######################" 
            ]
        ];

        function initGame() {
            document.getElementById("start-screen").style.display = "none";
            Audio.init();
            resize();
            preloadImages();
            loadLevel(0);
            requestAnimationFrame(gameLoop);
        }

        function loadLevel(idx) {
            levelIdx = idx;
            if (levelIdx >= LEVELS.length) {
                Audio.levelup();
                alert(`YOU WIN! Final Score: ${inventory.score}`);
                location.reload(); 
                return;
            }
            if (idx > 0) Audio.levelup();

            const map = LEVELS[levelIdx];
            walls = [];
            items = [];

            for (let y = 0; y < map.length; y++) {
                for (let x = 0; x < map[y].length; x++) {
                    let char = map[y][x];
                    if (char === "#") walls.push({x, y});
                    else if (char === "@") { player.x = x; player.y = y; }
                    else if (char === "E" || char === "$" || char === "H") {
                        let pool = (char === "$") ? BOSS_QUESTIONS : REGULAR_QUESTIONS;
                        let qData = pool[Math.floor(Math.random() * pool.length)];
                        items.push({ x, y, type: char, quest: qData, id: Math.random(), isMoving: (char === "E") });
                    } 
                    else if ("KDP>NS".includes(char)) items.push({ x, y, type: char, id: Math.random() });
                }
            }
            updateHUD();
            setTimeout(() => openUI("CHAPTER " + (idx+1), STORY_TEXT[idx], false), 500);
        }

        function updateHUD() {
            document.getElementById("key-count").innerText = inventory.keys;
            document.getElementById("score-val").innerText = inventory.score;
            document.getElementById("potion-status").innerText = inventory.vision ? "ON" : "OFF";
            document.getElementById("potion-status").style.color = inventory.vision ? "#55efc4" : "#636e72";
            let currentRank = "NOVICE";
            for(let r of RANKS) {
                if(inventory.score >= r.score) currentRank = r.title;
            }
            document.getElementById("rank-display").innerText = currentRank;
        }

        function addScore(points) { inventory.score += points; updateHUD(); }

        // --- 7. GAME LOOP ---
        function gameLoop() {
            if(!isPaused) { updateEnemies(); draw(); }
            requestAnimationFrame(gameLoop);
        }

        function updateEnemies() {
            moveTimer++;
            if (moveTimer > 80) { 
                moveTimer = 0;
                items.forEach(item => {
                    if (item.isMoving) {
                        let dirs = [[0,1], [0,-1], [1,0], [-1,0]];
                        let move = dirs[Math.floor(Math.random() * dirs.length)];
                        let nx = item.x + move[0];
                        let ny = item.y + move[1];
                        if (!isWall(nx, ny) && !isPlayer(nx, ny) && !isItem(nx, ny)) {
                            item.x = nx;
                            item.y = ny;
                        }
                    }
                });
            }
        }

        function isWall(x, y) { return walls.some(w => w.x === x && w.y === y); }
        function isPlayer(x, y) { return player.x === x && player.y === y; }
        function isItem(x, y) { return items.some(i => i.x === x && i.y === y); }

        // --- 8. DRAWING ---
        function draw() {
            CTX.fillStyle = "#050505";
            CTX.fillRect(0, 0, CANVAS.width, CANVAS.height);
            let offsetX = (CANVAS.width / 2) - (player.x * TILE_SIZE) - (TILE_SIZE / 2);
            let offsetY = (CANVAS.height / 2) - (player.y * TILE_SIZE) - (TILE_SIZE / 2);
            CTX.save();
            CTX.translate(offsetX, offsetY);

            const map = LEVELS[levelIdx];
            for (let y = 0; y < map.length; y++) {
                for (let x = 0; x < map[y].length; x++) {
                    let char = map[y][x];
                    drawTile(x, y, ".", 0); 
                    if (char === "#") drawTile(x, y, "#", 0);
                }
            }

            const bob = Math.sin(Date.now() / 200) * 5;
            items.forEach(item => {
                if (item.type === "H" && !inventory.vision) { /* Invisible */ } 
                else {
                    let yOffset = (item.type === "E" || item.type === "N" || item.type === "$") ? bob : 0;
                    drawTile(item.x, item.y, item.type, yOffset);
                }
            });

            drawTile(player.x, player.y, "@", bob);
            CTX.restore();
        }

        function drawTile(x, y, type, yOffset) {
            const px = x * TILE_SIZE;
            const py = (y * TILE_SIZE) + yOffset;
            const img = IMAGES[type];
            if (img && img.complete && img.naturalHeight !== 0) {
                CTX.drawImage(img, px, py, TILE_SIZE, TILE_SIZE);
                return;
            } 
            if (type === "#") { CTX.fillStyle = "#444"; CTX.fillRect(px, py, TILE_SIZE, TILE_SIZE); return; }
            if (type === ".") { CTX.fillStyle = "#111"; CTX.fillRect(px, py, TILE_SIZE, TILE_SIZE); return; }
            
            CTX.font = (TILE_SIZE * 0.6) + "px Arial";
            CTX.textAlign = "center"; CTX.textBaseline = "middle";
            let cx = px + TILE_SIZE/2; let cy = py + TILE_SIZE/2;

            if (type === "K") CTX.fillText("üîë", cx, cy);
            else if (type === "D") { CTX.fillStyle = "#e67e22"; CTX.fillRect(px, py, TILE_SIZE, TILE_SIZE); CTX.fillStyle="white"; CTX.fillText("üîí", cx, cy); }
            else if (type === "P") CTX.fillText("üß™", cx, cy);
            else if (type === "H") CTX.fillText("‚ö†Ô∏è", cx, cy);
            else if (type === "@") { CTX.fillStyle = "#6c5ce7"; CTX.fillRect(px, py, TILE_SIZE, TILE_SIZE); }
            else if (type === "E") { CTX.fillStyle = "#d63031"; CTX.fillRect(px, py, TILE_SIZE, TILE_SIZE); }
            else if (type === ">") { CTX.fillStyle = "#ffeaa7"; CTX.fillRect(px, py, TILE_SIZE, TILE_SIZE); }
            else { CTX.fillStyle = "green"; CTX.fillRect(px, py, TILE_SIZE, TILE_SIZE); }
        }

        // --- 9. MOVEMENT ---
        function handleInput(dx, dy) {
            if (isPaused) return;
            if (dx !== 0 || dy !== 0) {
                let nx = player.x + dx;
                let ny = player.y + dy;
                if (isWall(nx, ny)) { Audio.error(); return; }

                let item = items.find(i => i.x === nx && i.y === ny);
                if (item) {
                    if (item.type === "N") { openUI("Wizard", "Greetings!", false); } 
                    else if (item.type === "K") {
                        inventory.keys++; Audio.pickup(); items = items.filter(i => i !== item); addScore(20); player.x = nx; player.y = ny;
                    }
                    else if (item.type === "P") {
                        inventory.vision = true; updateHUD(); Audio.pickup(); openUI("Potion Drinker", "Hidden traps revealed!", false); items = items.filter(i => i !== item); addScore(20); player.x = nx; player.y = ny;
                    }
                    else if (item.type === "D") {
                        if (inventory.keys > 0) {
                            inventory.keys--; Audio.unlock(); items = items.filter(i => i !== item); openUI("Unlocked!", "Door opened.", false); updateHUD();
                        } else {
                            openUI("Locked", "You need a key üîë.", false);
                        }
                    }
                    else if (item.type === "E" || item.type === "H") {
                        currentEnemy = item; openUI("BATTLE", item.quest.q, true);
                    }
                    else if (item.type === "$") {
                        currentEnemy = item; openUI("BOSS BATTLE", item.quest.q, true);
                    } 
                    else if (item.type === ">") {
                        addScore(100); loadLevel(levelIdx + 1);
                    }
                } else {
                    player.x = nx; player.y = ny;
                    Audio.step();
                }
            }
        }

        window.addEventListener("keydown", (e) => {
            let dx = 0, dy = 0;
            if (e.key === "ArrowLeft") dx = -1;
            if (e.key === "ArrowRight") dx = 1;
            if (e.key === "ArrowUp") dy = -1;
            if (e.key === "ArrowDown") dy = 1;
            handleInput(dx, dy);
        });

        // --- 10. UI SYSTEM ---
        const UI = document.getElementById("ui-layer");
        const INPUT = document.getElementById("answer");

        function openUI(title, text, isBattle) {
            isPaused = true;
            UI.style.display = "block";
            document.getElementById("ui-title").innerText = title;
            document.getElementById("ui-text").innerText = text;
            document.getElementById("feedback").innerText = "";
            INPUT.value = "";

            if (isBattle) {
                document.getElementById("battle-ui").style.display = "block";
                document.getElementById("close-btn").style.display = "none";
                setTimeout(() => INPUT.focus(), 100);
            } else {
                document.getElementById("battle-ui").style.display = "none";
                document.getElementById("close-btn").style.display = "inline-block";
            }
        }

        function closeUI() {
            UI.style.display = "none";
            isPaused = false;
        }

        window.checkAnswer = function() {
            if (!currentEnemy) return;
            const attempt = INPUT.value.toLowerCase().trim();
            const correct = currentEnemy.quest.a.toLowerCase().trim();
            if (attempt === correct) {
                Audio.magic();
                if (currentEnemy.type === "$") {
                    items = items.filter(i => i !== currentEnemy);
                    addScore(500);
                    closeUI();
                    setTimeout(() => { alert("BOSS DEFEATED! YOU WIN!"); location.reload(); }, 500);
                    return;
                }
                items = items.filter(i => i !== currentEnemy);
                addScore(50);
                closeUI();
            } else {
                Audio.error();
                document.getElementById("feedback").innerText = "WRONG! Try again.";
            }
        }

        INPUT.addEventListener("keypress", (e) => {
            if (e.key === "Enter") checkAnswer();
        });
        
        function resize() {
            CANVAS.width = window.innerWidth;
            CANVAS.height = window.innerHeight;
            if(assetsLoaded === totalAssets) draw();
        }
        window.addEventListener('resize', resize);
        window.closeUI = closeUI;

    </script>
</body>
</html>
