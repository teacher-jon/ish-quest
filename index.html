<!DOCTYPE html>
<html>
<head>
    <title>Suffixia: HD Edition</title>
    <style>
        body { 
            margin: 0; 
            background: #111; 
            overflow: hidden; /* No scrollbars */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            color: white; 
        }
        
        canvas { 
            display: block; 
            background: #181818; 
        }
        
        /* UI OVERLAY */
        #ui-layer {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(20, 20, 30, 0.95); 
            color: white; 
            padding: 30px; 
            border: 2px solid #4a90e2;
            border-radius: 15px;
            text-align: center; 
            display: none; 
            width: 400px;
            box-shadow: 0 0 50px rgba(74, 144, 226, 0.3);
            backdrop-filter: blur(5px);
        }

        h2#ui-title { margin-top: 0; color: #4a90e2; text-transform: uppercase; letter-spacing: 2px; }
        p#ui-text { font-size: 18px; line-height: 1.5; color: #ddd; }

        input { 
            padding: 12px; font-size: 18px; text-align: center; width: 80%; margin-top: 15px;
            background: #333; border: 1px solid #555; color: white; border-radius: 5px;
        }
        
        button { 
            padding: 12px 24px; font-size: 16px; cursor: pointer; margin-top: 20px;
            background: #4a90e2; color: white; border: none; border-radius: 5px; font-weight: bold;
            transition: transform 0.1s, background 0.1s;
        }
        button:hover { background: #357abd; transform: scale(1.05); }
        
        #loading { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 24px; font-weight: bold; letter-spacing: 3px;
        }
    </style>
</head>
<body>

    <div id="loading">LOADING HIGH-RES ASSETS...</div>
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <h2 id="ui-title">Quest</h2>
        <p id="ui-text">...</p>
        
        <div id="battle-ui" style="display:none">
            <input type="text" id="answer" placeholder="Type word ending in -ish" autocomplete="off">
            <br>
            <button onclick="checkAnswer()">CAST SPELL</button>
        </div>
        
        <button id="close-btn" onclick="closeUI()" style="display:none">CONTINUE</button>
        <p id="feedback" style="color:#ff6b6b; font-weight:bold; min-height: 20px; margin-top:15px;"></p>
    </div>

    <script>
        // --- 1. HD CONFIGURATION ---
        const TILE_SIZE = 64; // Increased size (was 32/48) to show details
        const CANVAS = document.getElementById("gameCanvas");
        const CTX = CANVAS.getContext("2d");

        // --- 2. RESIZE HANDLER (Full Screen) ---
        function resize() {
            CANVAS.width = window.innerWidth;
            CANVAS.height = window.innerHeight;
            // Crisp pixel art look (optional, keeps lines sharp)
            CTX.imageSmoothingEnabled = false; 
            if(assetsLoaded === totalAssets) draw();
        }
        window.addEventListener('resize', resize);

        // --- 3. ASSETS ---
        const ASSETS = {
            "@": "images/hero.png",
            "#": "images/wall.png",
            ".": "images/floor.png",
            "N": "images/npc.png",
            ">": "images/stairs.png",
            "E": "images/enemy.png",
            "$": "images/boss.png"
        };

        const IMAGES = {};
        let assetsLoaded = 0;
        const totalAssets = Object.keys(ASSETS).length;

        function preloadImages() {
            for (let key in ASSETS) {
                const img = new Image();
                img.src = ASSETS[key];
                img.onload = () => { assetsLoaded++; checkLoad(); };
                img.onerror = () => { 
                    console.error("Missing: " + ASSETS[key]); 
                    assetsLoaded++; checkLoad(); 
                };
                IMAGES[key] = img;
            }
        }

        function checkLoad() {
            if (assetsLoaded === totalAssets) {
                document.getElementById("loading").style.display = "none";
                resize(); // Set initial size
                requestAnimationFrame(gameLoop); // Start Animation Loop
            }
        }

        // --- 4. GAME DATA ---
        let player = { x: 1, y: 1 };
        let levelIdx = 0;
        let isPaused = false;
        let currentEnemy = null;
        let walls = [];
        let items = [];

        // LEVELS
        const LEVELS = [
            [
                "####################",
                "#..................#",
                "#.N................#",
                "#.......#....E.....#",
                "#.......#..........#",
                "#...#.......@......#",
                "#...#..............#",
                "#...#........>.....#",
                "#...#..............#",
                "####################"
            ],
            [
                "####################",
                "#@..E...#...E......#",
                "#.......#.......#..#",
                "###.#####...#####..#",
                "#.......E.......#..#",
                "#.N.............#..#",
                "#########...#####..#",
                "#...........#......#",
                "#...........#...>..#",
                "####################"
            ],
            [
                "####################",
                "#..................#",
                "#.@.#...#...#...#..#",
                "#...#...#...#...#..#",
                "#...E.......E......#",
                "#..................#",
                "#.........$........#",
                "#..................#",
                "#..................#",
                "####################"
            ]
        ];

        const QUESTS = {
            "greenish": { clue: "Sickly pale color...", answer: "greenish" },
            "boyish": { clue: "Grown man, young face...", answer: "boyish" },
            "ticklish": { clue: "Laughs when feet touched...", answer: "ticklish" },
            "stylish": { clue: "Wears trendy clothes...", answer: "stylish" },
            "squeamish": { clue: "Faints at sight of blood...", answer: "squeamish" }
        };

        // --- 5. ENGINE ---
        
        function loadLevel(idx) {
            levelIdx = idx;
            if (levelIdx >= LEVELS.length) {
                alert("YOU HAVE CONQUERED SUFFIXIA!");
                levelIdx = 0;
            }

            const map = LEVELS[levelIdx];
            walls = [];
            items = [];

            for (let y = 0; y < map.length; y++) {
                for (let x = 0; x < map[y].length; x++) {
                    let char = map[y][x];
                    if (char === "#") walls.push({x, y});
                    else if (char === "@") { player.x = x; player.y = y; }
                    else if (char === "E" || char === "$") {
                        const keys = Object.keys(QUESTS);
                        const q = QUESTS[keys[Math.floor(Math.random() * keys.length)]];
                        items.push({ x, y, type: char, quest: q, id: Math.random() });
                    } 
                    else if (char !== ".") items.push({ x, y, type: char, id: Math.random() });
                }
            }
        }

        // --- 6. RENDERER (With Animation) ---
        
        function gameLoop() {
            if(!isPaused) draw();
            requestAnimationFrame(gameLoop);
        }

        function draw() {
            // Clear
            CTX.fillStyle = "#151515";
            CTX.fillRect(0, 0, CANVAS.width, CANVAS.height);

            // Calculate Center Camera
            let offsetX = (CANVAS.width / 2) - (player.x * TILE_SIZE) - (TILE_SIZE / 2);
            let offsetY = (CANVAS.height / 2) - (player.y * TILE_SIZE) - (TILE_SIZE / 2);

            CTX.save();
            CTX.translate(offsetX, offsetY);

            // Breathing Animation Offset (Bobbing up and down)
            const bob = Math.sin(Date.now() / 200) * 3; 

            // 1. Draw Map & Walls
            const map = LEVELS[levelIdx];
            for (let y = 0; y < map.length; y++) {
                for (let x = 0; x < map[y].length; x++) {
                    let char = map[y][x];
                    
                    // Floor (No bobbing)
                    drawTile(x, y, ".", 0); 
                    
                    if (char === "#") {
                        drawTile(x, y, "#", 0); // Walls don't bob
                    }
                }
            }

            // 2. Draw Items (Enemies/NPCs Bob)
            items.forEach(item => {
                let yOffset = (item.type === "E" || item.type === "N" || item.type === "$") ? bob : 0;
                drawTile(item.x, item.y, item.type, yOffset);
            });

            // 3. Draw Player (Bobs)
            drawTile(player.x, player.y, "@", bob);

            CTX.restore();
        }

        function drawTile(x, y, type, yOffset) {
            const img = IMAGES[type];
            const px = x * TILE_SIZE;
            const py = (y * TILE_SIZE) + yOffset; // Apply animation

            if (img && img.complete && img.naturalHeight !== 0) {
                // Draw Image scaled to TILE_SIZE
                CTX.drawImage(img, px, py, TILE_SIZE, TILE_SIZE);
            } else {
                // Fallback Colors
                if (type === "#") CTX.fillStyle = "#555";
                else if (type === ".") CTX.fillStyle = "#222";
                else if (type === "@") CTX.fillStyle = "#4a90e2";
                else if (type === "E") CTX.fillStyle = "#e74c3c";
                else if (type === ">") CTX.fillStyle = "#f1c40f";
                else CTX.fillStyle = "#2ecc71";
                
                CTX.fillRect(px, py, TILE_SIZE, TILE_SIZE);
            }
        }

        // --- 7. CONTROLS ---

        window.addEventListener("keydown", (e) => {
            if (isPaused) return;
            let dx = 0, dy = 0;
            if (e.key === "ArrowLeft") dx = -1;
            if (e.key === "ArrowRight") dx = 1;
            if (e.key === "ArrowUp") dy = -1;
            if (e.key === "ArrowDown") dy = 1;
            if (dx !== 0 || dy !== 0) move(dx, dy);
        });

        function move(dx, dy) {
            let nextX = player.x + dx;
            let nextY = player.y + dy;

            if (walls.some(w => w.x === nextX && w.y === nextY)) return;

            let item = items.find(i => i.x === nextX && i.y === nextY);
            if (item) {
                if (item.type === "N") {
                    openUI("Wizard", "Greetings! Add '-ish' to words to reveal their nature.", false);
                } else if (item.type === "E" || item.type === "$") {
                    currentEnemy = item;
                    openUI("Battle Mode", item.quest.clue, true);
                } else if (item.type === ">") {
                    loadLevel(levelIdx + 1);
                }
                return; 
            }

            player.x = nextX;
            player.y = nextY;
        }

        // --- 8. UI LOGIC ---

        const UI = document.getElementById("ui-layer");
        const INPUT = document.getElementById("answer");

        function openUI(title, text, isBattle) {
            isPaused = true;
            UI.style.display = "block";
            document.getElementById("ui-title").innerText = title;
            document.getElementById("ui-text").innerText = text;
            document.getElementById("feedback").innerText = "";
            INPUT.value = "";

            if (isBattle) {
                document.getElementById("battle-ui").style.display = "block";
                document.getElementById("close-btn").style.display = "none";
                setTimeout(() => INPUT.focus(), 100);
            } else {
                document.getElementById("battle-ui").style.display = "none";
                document.getElementById("close-btn").style.display = "inline-block";
            }
        }

        function closeUI() {
            UI.style.display = "none";
            isPaused = false;
        }

        window.checkAnswer = function() {
            if (!currentEnemy) return;
            if (INPUT.value.toLowerCase().trim() === currentEnemy.quest.answer) {
                items = items.filter(i => i !== currentEnemy);
                closeUI();
            } else {
                document.getElementById("feedback").innerText = "WRONG! Try again.";
            }
        }
        
        INPUT.addEventListener("keypress", (e) => {
            if (e.key === "Enter") checkAnswer();
        });
        window.closeUI = closeUI;

        // START
        preloadImages();
        loadLevel(0);

    </script>
</body>
</html>
